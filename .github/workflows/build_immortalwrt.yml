name: ğŸš€ ç¼–è¯‘ ImmortalWrt

on:
  workflow_dispatch:
    inputs:
      owner:
        description: "ä»“åº“æ‹¥æœ‰è€…"
        type: string
        required: true
        default: "immortalwrt"
      repo:
        description: "ä»“åº“åç§°"
        type: string
        required: true
        default: "immortalwrt"
      branch:
        description: "åˆ†æ”¯"
        type: string
        required: true
        default: "openwrt-24.10"
      multithreading:
        description: "å¤šçº¿ç¨‹ç¼–è¯‘"
        type: boolean
        default: true
      ssh:
        description: "SSH è°ƒè¯•"
        type: boolean
        default: false
      upload_files:
        description: "åŒ…å« files ç›®å½•"
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    name: ğŸš€ ç¼–è¯‘å›ºä»¶
    
    steps:
      - name: ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential ccache cmake curl file g++ gcc git libncurses5-dev \
            libssl-dev python3 python3-setuptools rsync unzip wget \
            ack autoconf automake bison flex libtool pkg-config scons \
            gawk gettext gperf help2man intltool zlib1g-dev

      - name: ğŸ“¥ å…‹éš†é…ç½®ä»“åº“
        uses: actions/checkout@v4
        with:
          path: config-repo

      - name: ğŸ“¥ å…‹éš† ImmortalWrt æºç 
        uses: actions/checkout@v4
        with:
          repository: "${{ inputs.owner }}/${{ inputs.repo }}"
          ref: ${{ inputs.branch }}
          path: source

      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶ç»“æ„
        run: |
          echo "=== é…ç½®ä»“åº“ç»“æ„ ==="
          find config-repo -type f -name "*.sh" -o -name "*.config" | sort
          echo "=== æºç ä»“åº“ç»“æ„ ==="
          ls -la source/

      - name: âš™ï¸ å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æºç ç›®å½•
        run: |
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp config-repo/.config source/
          
          # å¤åˆ¶è„šæœ¬æ–‡ä»¶
          cp -r config-repo/scripts source/
          
          # å¤åˆ¶è®¾å¤‡æ–‡ä»¶
          cp -r config-repo/beeconmini-seed-ac2 source/
          
          echo "å¤åˆ¶å®Œæˆï¼Œæ£€æŸ¥ç›®æ ‡ç›®å½•:"
          ls -la source/scripts/

      - name: ğŸ“ å¤åˆ¶ files ç›®å½•
        if: ${{ inputs.upload_files }}
        run: |
          if [ -d "config-repo/files" ]; then
            cp -r config-repo/files source/
            echo "âœ… files ç›®å½•å¤åˆ¶å®Œæˆ"
          else
            echo "âš ï¸  config-repo/files ç›®å½•ä¸å­˜åœ¨"
          fi

      - name: ğŸ› ï¸ æ‰§è¡Œè‡ªå®šä¹‰é…ç½®
        working-directory: source
        run: |
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "è„šæœ¬æ–‡ä»¶:"
          ls -la scripts/
          chmod +x scripts/diy.sh
          ./scripts/diy.sh

      - name: ğŸ“š æ›´æ–°è½¯ä»¶æº
        working-directory: source
        run: ./scripts/feeds update -a && ./scripts/feeds install -a

      - name: ğŸ¨ æ‰§è¡ŒåæœŸé…ç½®
        working-directory: source
        run: |
          chmod +x scripts/post-diy.sh
          ./scripts/post-diy.sh

      - name: ğŸ” SSH è°ƒè¯•ä¼šè¯
        if: ${{ inputs.ssh }}
        uses: csexton/debugger-action@master

      - name: â¬‡ï¸ ä¸‹è½½æºç åŒ…
        working-directory: source
        run: make download -j$(nproc)

      - name: ğŸ—ï¸ ç¼–è¯‘å›ºä»¶
        working-directory: source
        run: |
          if [ "${{ inputs.multithreading }}" = "true" ]; then
            make -j$(nproc) V=s
          else
            make -j1 V=s
          fi

      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.sha }}
          path: source/bin/targets