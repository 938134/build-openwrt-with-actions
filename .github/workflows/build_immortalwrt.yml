name: ğŸš€ ç¼–è¯‘ ImmortalWrt

on:
  workflow_dispatch:
    inputs:
      owner:
        description: "ä»“åº“æ‹¥æœ‰è€…"
        type: string
        required: true
        default: "immortalwrt"
      repo:
        description: "ä»“åº“åç§°"
        type: string
        required: true
        default: "immortalwrt"
      branch:
        description: "åˆ†æ”¯"
        type: string
        required: true
        default: "openwrt-24.10"
      multithreading:
        description: "å¤šçº¿ç¨‹ç¼–è¯‘"
        type: boolean
        default: true
      ssh:
        description: "SSH è°ƒè¯•"
        type: boolean
        default: false
      include_files:
        description: "åŒ…å« files å¤§æ³•ç›®å½•"
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    name: ğŸš€ ç¼–è¯‘å›ºä»¶
    
    env:
      DEVICE_NAME: "beeconmini-seed-ac2"
      DEVICE_CONFIG: "ac2.config"
      BUILD_DIR: "source"
      ARTIFACT_RETENTION_DAYS: 7
      TIMESTAMP_FORMAT: "%Y%m%d-%H%M%S"
    
    steps:
      - name: ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential ccache cmake curl file g++ gcc git libncurses5-dev \
            libssl-dev python3 python3-setuptools rsync unzip wget \
            ack autoconf automake bison flex libtool pkg-config scons \
            gawk gettext gperf help2man intltool zlib1g-dev

      - name: ğŸ“¥ å…‹éš†å½“å‰ä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ“¥ å…‹éš† ImmortalWrt ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: "${{ inputs.owner }}/${{ inputs.repo }}"
          ref: ${{ inputs.branch }}
          path: ${{ env.BUILD_DIR }}

      - name: âš™ï¸ æ‰§è¡Œè‡ªå®šä¹‰é…ç½®
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          # å…ˆå¤åˆ¶æ–‡ä»¶åˆ°å½“å‰ç›®å½•
          cp ../diy.sh ./
          cp -rf ../${{ env.DEVICE_NAME }}/* ./
          echo "âœ… åŸºç¡€æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          
          # å¤åˆ¶ files å¤§æ³•ç›®å½•
          if [ -d "../files" ] && ${{ inputs.include_files }}; then
            cp -rf ../files ./
            echo "âœ… files å¤§æ³•ç›®å½•å¤åˆ¶å®Œæˆ"
          else
            echo "âš ï¸  files ç›®å½•ä¸å­˜åœ¨æˆ–æœªå¯ç”¨ include_filesï¼Œè·³è¿‡"
          fi
          
          # æ‰§è¡Œè‡ªå®šä¹‰é…ç½®
          chmod +x diy.sh
          ./diy.sh
          echo "ğŸ› ï¸ è‡ªå®šä¹‰é…ç½®æ‰§è¡Œå®Œæˆ"

      - name: ğŸ” SSH è°ƒè¯•ä¼šè¯
        if: ${{ inputs.ssh }}
        uses: csexton/debugger-action@master    
        
      - name: âš™ï¸ é…ç½®ç¼–è¯‘é€‰é¡¹
        working-directory: ${{ env.BUILD_DIR }}
        run: |
            # é¦–å…ˆç”Ÿæˆé»˜è®¤é…ç½®
            cp ${{ env.DEVICE_CONFIG }} .config
            make defconfig
            echo "âœ… ç¼–è¯‘é…ç½®å®Œæˆ"
        
      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘å‰é…ç½®
        uses: actions/upload-artifact@v4
        with:
          name: config
          path: |
            ${{ env.BUILD_DIR }}/${{ env.DEVICE_CONFIG }}
          retention-days: 1         

      - name: ğŸ—ï¸ ç¼–è¯‘å›ºä»¶
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          # å®Œå…¨é™é»˜ï¼Œåªåœ¨é”™è¯¯æ—¶æ˜¾ç¤º
          if [ "${{ inputs.multithreading }}" = "true" ]; then
            make -j$(nproc) V=0 || make -j1 V=s  # å¤±è´¥æ—¶æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
          else
            make -j1 V=0 || make V=s
          fi
      
      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE_NAME }}-$(date +'${{ env.TIMESTAMP_FORMAT }}')
          path: |
            ${{ env.BUILD_DIR }}/bin/targets
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
